load("@io_bazel_rules_kotlin//kotlin:kotlin.bzl", "kt_jvm_library")
load("@cloud_spanner_emulator//:defs.bzl", "workspace_path")

package(default_visibility = [
    "//src/main/kotlin/org/wfanet/measurement:__subpackages__",
    "//src/test/kotlin/org/wfanet/measurement:__subpackages__",
])

kt_jvm_library(
    name = "testing",
    testonly = True,
    srcs = glob(["*.kt"]),
    deps = [
        "//src/main/kotlin/org/wfanet/measurement/common/testing",
        "//third_party/java/com/google/api/core",
        "//third_party/java/com/google/cloud/spanner",
        "//third_party/java/org/junit",
        "//third_party/kotlin/kotlin/test",
        "//third_party/kotlin/kotlinx/coroutines:core",
        "@bazel_tools//tools/java/runfiles",
    ],
)

build_args = [
    workspace_path(),
    "//binaries:emulator_main",
    "$(execpath :cloud_spanner_emulator)",
]

genrule(
    name = "gen_cloud_spanner_emulator",
    outs = [
        "cloud_spanner_emulator",
    ],
    cmd_bash = " ".join(["$(execpath //src/main/kotlin/org/wfanet/measurement/build:bazel_build)"] + build_args),
    tags = ["no-sandbox"],
    tools = ["//src/main/kotlin/org/wfanet/measurement/build:bazel_build"],
)
